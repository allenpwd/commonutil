cache:
  |
    ##
    .{path_one}:
      only:
        changes:
    {cache}

    ##


all_build:
  |
    all_build:
      stage: build1
      extends:
        - .javaTemplate
      script:
        ##
        - if [ -d {path_one}/ ]; then mvn install -Dmaven.test.skip=true -f {path_one}/pom.xml; fi
        ##
      cache:
        <<: *maven_cache
      when: manual
      allow_failure: true


build:
  |
    ##
    {path_one}_build:
      stage: build{num}
      extends:
        - .javaTemplate
        - .{path_one}
      script:
        - mvn install -Dmaven.test.skip=true -f {path_one}/pom.xml
      artifacts:
        expire_in: 2 h
        paths:
          - {path}/target
      cache:
        <<: *maven_cache

    ##

test:
  |
    ##
    {path_one}_test:
      stage: test
      extends:
        - .javaTemplate
        - .{path_one}
      script:
        - mvn test -f {path_one}/pom.xml
      needs:
        - job: "{path_one}_build"
          artifacts: false
      cache:
        <<: *maven_cache
        policy: pull

    ##

sonar:
  |
    ##
    {path_one}_sonar:
      stage: sonarqube
      extends:
        - .javaTemplate
        - .{path_one}
      script:
        - mvn test sonar:sonar -f {path_one}/pom.xml
            -Dsonar.host.url=$URL_SONAR
            -Dsonar.projectName=农行_广东_{path_two_low}
            -Dsonar.login=$SONAR_LOGIN_TOKEN
      needs:
        - job: "{path_one}_test"
      cache:
        <<: *maven_cache
        policy: pull
      allow_failure: true

    ##


dockerpackage:
  |
    ##
    {path_one}_dockerpackage:
      stage: dockerpackage
      extends:
        - .javaTemplate
        - .{path_one}
      script:
        - ls -l {path}/target
      needs:
        - job: "{path_one}_build"
      when: manual

    ##

deploy:
  |
    ##
    {path_one}_deploy:
      stage: deploy
      tags:
        - push-tag
      extends:
        - .javaTemplate
        - .{path_one}
      script:
        - docker build -t "${PAAS_TAG_NAME_PREFIX}{path_two_low}:${TAG_NAME_SUFFIX}" -f {path}/Dockerfile ./{path}/
        #登录
        - docker login $CI_PAAS -u $CI_PAAS_USER -p $CI_PAAS_PASSWD
        #推送到蓝鲸平台后删除本地镜像
        - docker push ${PAAS_TAG_NAME_PREFIX}{path_two_low}:${TAG_NAME_SUFFIX}
        - docker logout
        - docker rmi ${PAAS_TAG_NAME_PREFIX}{path_two_low}:${TAG_NAME_SUFFIX}
      needs:
        - job: "{path_one}_build"
        - job: "{path_one}_dockerpackage"
      when: manual

    ##